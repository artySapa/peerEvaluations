<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ 360¬∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            color: #555;
        }
        select, input, textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        select {
            cursor: pointer;
        }
        .rating-box {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .rating-box button {
            flex: 1;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
        }
        .rating-box button:hover {
            background: #e0e0e0;
        }
        .rating-box button.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        .btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        .btn-primary {
            background: #2196F3;
            color: white;
        }
        .btn-primary:hover {
            background: #0b7dda;
        }
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        .btn-danger {
            background: #f44336;
            color: white;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 10px;
            background: #e0e0e0;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        .tab.active {
            background: #2196F3;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background: #2196F3;
            color: white;
        }
        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .alert-info {
            background: #e3f2fd;
            border: 1px solid #2196F3;
        }
        .alert-success {
            background: #e8f5e9;
            border: 1px solid #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –û—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ 360¬∞</h1>
        <p style="text-align: center; color: #666;">Family Business Succession</p>

        <div class="tabs">
            <button class="tab active" onclick="openTab('tab1')">–û—Ü–µ–Ω–∏—Ç—å</button>
            <button class="tab" onclick="openTab('tab2')">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
            <button class="tab" onclick="openTab('tab3')">–ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç</button>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê 1: –û–¶–ï–ù–ò–í–ê–ù–ò–ï -->
        <div id="tab1" class="tab-content active">
            <div class="alert alert-info">
                <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong><br>
                1. –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–≥–æ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ<br>
                2. –í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—ë –∏–º—è<br>
                3. –ü–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫–∏ 1-5 –ø–æ –∫–∞–∂–¥–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é<br>
                4. –ù–∞–∂–º–∏—Ç–µ "–°–∫–∞—á–∞—Ç—å –æ—Ü–µ–Ω–∫—É" –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—é
            </div>

            <div class="section">
                <label>–û—Ü–µ–Ω–∏–≤–∞–µ–º—ã–π —Å—Ç—É–¥–µ–Ω—Ç:</label>
                <select id="evaluated"></select>
            </div>

            <div class="section">
                <label>–í–∞—à–µ –∏–º—è (–æ—Ü–µ–Ω–∏–≤–∞—é—â–∏–π):</label>
                <select id="evaluator"></select>
            </div>

            <div class="section">
                <label>–î–∞—Ç–∞:</label>
                <input type="date" id="date">
            </div>

            <div id="evaluationWarning" style="display: none; margin: 15px 0;"></div>

            <div class="section">
                <h3>–ö—Ä–∏—Ç–µ—Ä–∏–π 1: –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∏ –ø–æ–ª–Ω–æ—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ (30%)</h3>
                <div class="rating-box" id="rating1">
                    <button onclick="rate(1,1)">1</button>
                    <button onclick="rate(1,2)">2</button>
                    <button onclick="rate(1,3)">3</button>
                    <button onclick="rate(1,4)">4</button>
                    <button onclick="rate(1,5)">5</button>
                </div>
                <textarea id="comment1" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="2"></textarea>
            </div>

            <div class="section">
                <h3>–ö—Ä–∏—Ç–µ—Ä–∏–π 2: –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (25%)</h3>
                <div class="rating-box" id="rating2">
                    <button onclick="rate(2,1)">1</button>
                    <button onclick="rate(2,2)">2</button>
                    <button onclick="rate(2,3)">3</button>
                    <button onclick="rate(2,4)">4</button>
                    <button onclick="rate(2,5)">5</button>
                </div>
                <textarea id="comment2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="2"></textarea>
            </div>

            <div class="section">
                <h3>–ö—Ä–∏—Ç–µ—Ä–∏–π 3: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ª–æ–≥–∏–∫–∞ –∏–∑–ª–æ–∂–µ–Ω–∏—è (20%)</h3>
                <div class="rating-box" id="rating3">
                    <button onclick="rate(3,1)">1</button>
                    <button onclick="rate(3,2)">2</button>
                    <button onclick="rate(3,3)">3</button>
                    <button onclick="rate(3,4)">4</button>
                    <button onclick="rate(3,5)">5</button>
                </div>
                <textarea id="comment3" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="2"></textarea>
            </div>

            <div class="section">
                <h3>–ö—Ä–∏—Ç–µ—Ä–∏–π 4: –ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (15%)</h3>
                <div class="rating-box" id="rating4">
                    <button onclick="rate(4,1)">1</button>
                    <button onclick="rate(4,2)">2</button>
                    <button onclick="rate(4,3)">3</button>
                    <button onclick="rate(4,4)">4</button>
                    <button onclick="rate(4,5)">5</button>
                </div>
                <textarea id="comment4" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="2"></textarea>
            </div>

            <div class="section">
                <h3>–ö—Ä–∏—Ç–µ—Ä–∏–π 5: –£–º–µ–Ω–∏–µ –¥–æ–Ω–µ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (10%)</h3>
                <div class="rating-box" id="rating5">
                    <button onclick="rate(5,1)">1</button>
                    <button onclick="rate(5,2)">2</button>
                    <button onclick="rate(5,3)">3</button>
                    <button onclick="rate(5,4)">4</button>
                    <button onclick="rate(5,5)">5</button>
                </div>
                <textarea id="comment5" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="2"></textarea>
            </div>

            <button class="btn btn-primary" onclick="saveEvaluation()">üíæ –°–∫–∞—á–∞—Ç—å –æ—Ü–µ–Ω–∫—É (JSON —Ñ–∞–π–ª)</button>
            <button class="btn btn-success" onclick="uploadToGoogleDrive()" style="margin-top: 10px;">‚òÅÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ Google Drive</button>
            <button class="btn btn-primary" onclick="uploadAllToGoogleDrive()" style="margin-top: 10px;">‚òÅÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –í–°–ï –æ—Ü–µ–Ω–∫–∏ –Ω–∞ Google Drive</button>
            
            <div id="driveStatus" style="margin-top: 15px; display: none;"></div>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê 2: –ü–†–û–°–ú–û–¢–† -->
        <div id="tab2" class="tab-content">
            <div class="alert alert-info">
                <strong>–°–ø–æ—Å–æ–±—ã –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:</strong><br>
                1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –æ—Ü–µ–Ω–æ–∫ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç"<br>
                2. –ò–ª–∏ —Å–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª—ã —Å Google Drive (–∫–Ω–æ–ø–∫–∞ –Ω–∏–∂–µ)
            </div>
            
            <div class="section">
                <h3>üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Å Google Drive</h3>
                <button class="btn btn-primary" onclick="downloadFromGoogleDrive()">‚òÅÔ∏è –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª—ã —Å Google Drive</button>
                <div id="driveDownloadStatus" style="margin-top: 15px; display: none;"></div>
            </div>
            
            <div id="summaryTable"></div>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê 3: –ò–ú–ü–û–†–¢/–≠–ö–°–ü–û–†–¢ -->
        <div id="tab3" class="tab-content">
            <div class="alert alert-info">
                <strong>–î–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è:</strong> –°–æ–±–µ—Ä–∏—Ç–µ –≤—Å–µ JSON-—Ñ–∞–π–ª—ã –æ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –æ–¥–Ω—É –ø–∞–ø–∫—É –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏—Ö –û–î–ù–û–í–†–ï–ú–ï–ù–ù–û –∑–¥–µ—Å—å. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç –æ—Ü–µ–Ω–∫–∏ –∏ —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç —Å—Ä–µ–¥–Ω–∏–µ –±–∞–ª–ª—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞.
            </div>

            <div class="section">
                <h3>üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞</h3>
            <input type="file" id="fileInput" accept=".json" multiple style="margin: 20px 0;">
            <button class="btn btn-success" onclick="loadFiles()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –í–°–ï —Ñ–∞–π–ª—ã –æ—Ü–µ–Ω–æ–∫</button>
            
            <div id="uploadInfo" style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 5px; display: none;">
                <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong><br>
                1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ<br>
                2. –í—ã–±–µ—Ä–∏—Ç–µ –í–°–ï JSON —Ñ–∞–π–ª—ã —Å—Ä–∞–∑—É (Ctrl+A –∏–ª–∏ Cmd+A)<br>
                3. –ù–∞–∂–º–∏—Ç–µ "–û—Ç–∫—Ä—ã—Ç—å"<br>
                4. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã
                </div>
            </div>
            
            <div class="section">
                <h3>‚òÅÔ∏è –†–∞–±–æ—Ç–∞ —Å Google Drive</h3>
                <button class="btn btn-primary" onclick="downloadFromGoogleDrive()">üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª—ã —Å Google Drive</button>
                <button class="btn btn-success" onclick="uploadAllToGoogleDrive()" style="margin-top: 10px;">‚òÅÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –í–°–ï –æ—Ü–µ–Ω–∫–∏ –Ω–∞ Google Drive</button>
                <div id="driveDownloadStatus" style="margin-top: 15px; display: none;"></div>
            </div>
            
            <hr style="margin: 30px 0;">
            
            <div class="section">
                <h3>üìä –≠–∫—Å–ø–æ—Ä—Ç –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h3>
            <button class="btn btn-success" onclick="exportCSV()">üì• –°–∫–∞—á–∞—Ç—å CSV –¥–ª—è Excel</button>
            <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
            </div>

            <div id="stats" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script src="./public/env-config.js"></script>
    <script>
        // Google API initialization functions - must be defined before script tags
        function gapiLoaded() {
            console.log('GAPI loaded, starting client initialization...');
            
            if (typeof gapi !== 'undefined' && typeof gapi.load === 'function') {
                // Add a small delay to ensure everything is ready
                setTimeout(() => {
                    gapi.load('client', initializeGapiClient);
                }, 100);
            } else {
                console.error('GAPI not properly loaded');
                // Retry after a delay
                setTimeout(() => {
                    if (typeof gapi !== 'undefined' && typeof gapi.load === 'function') {
                        console.log('Retrying GAPI load...');
                        gapi.load('client', initializeGapiClient);
                    }
                }, 1000);
            }
        }

        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            gapi.client.setToken(tokenResponse);
                        } else {
                            console.error('Failed to get access token');
                        }
                    },
                    // Use explicit redirect URI
                    redirect_uri: window.location.origin
                });
                gisInited = true;
                console.log('Google Identity Services initialized successfully');
                updateAPIStatus();
            } catch(err) {
                console.log('Error initializing GIS');
                gisInited = false;
                updateAPIStatus();
            }
        }

        // Initialize GAPI client
        function initializeGapiClient() {
            gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
            }).then(() => {
                console.log('GAPI client initialized successfully');
                gapiInited = true;
                updateAPIStatus();
            }).catch((error) => {
                console.error('Error initializing GAPI:', error);
                updateAPIStatus();
            });
        }

        // Update API status display
        function updateAPIStatus() {
            const apiStatusText = document.getElementById('apiStatusText');
            const retryAPI = document.getElementById('retryAPI');
            
            if (apiStatusText) {
                if (gapiInited && gisInited) {
                    apiStatusText.innerHTML = '‚úÖ Google Drive API –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é';
                    apiStatusText.style.color = '#4CAF50';
                } else {
                    apiStatusText.innerHTML = '‚ö†Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google Drive API...';
                    apiStatusText.style.color = '#FF9800';
                }
            }
            
            if (retryAPI) {
                retryAPI.style.display = (gapiInited && gisInited) ? 'none' : 'inline-block';
            }
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script>
        const students = [
            "–ê–±–¥—É–ª—Ñ–∞–∏–∑–æ–≤–∞ –ö–∞—Ä–∏–Ω–∞ –†—É—Å—Ç–∞–º–æ–≤–Ω–∞",
            "–ê–±–¥—ã—Å–∞–¥—ã–∫–æ–≤ –ï—Ä–∞—Å—ã–ª –°–∞—Ä–¥–∞—Ä—É–ª—ã",
            "–ê–Ω—Ç–æ–Ω–µ–Ω–∫–æ –î–∞–Ω–∏–ª –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–∏—á",
            "–ë—É—Ö–∞—Ä–±–∞–π –ï—Ä—Å“±–ª—Ç–∞–Ω –ê—Å–µ—Ç“±–ª—ã",
            "–í–∞—Ö–∏—Ç–æ–≤–∞ –ñ–∞–∑–∏—Ä–∞ –û–ª–∂–∞—Å–æ–≤–Ω–∞",
            "–î–æ—Ä—Ç–º–∞–Ω –ù–∏–∫–∞ –ö–∏—Ä–∏–ª–ª–æ–≤–Ω–∞",
            "–î—É–±–∏–Ω–∏–Ω–∞ –ú–∏–ª–µ–Ω–∞ –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–Ω–∞",
            "–ñ—ã–ª“õ–∞–π–¥–∞—Ä ”ò–ª—ñ—à–µ—Ä –ë–µ–π–µ–º–±–µ—Ç“±–ª—ã",
            "–ö–∞–Ω –ö–ª–∏–º–µ–Ω—Ç–∏–π –ì–µ–æ—Ä–≥–∏–µ–≤–∏—á",
            "“ö–∞—Å—ã–º –•–∞–Ω–≥–µ–ª–¥—ñ –ú–∞“õ—Å–∞—Ç“±–ª—ã",
            "–õ–µ–≤–æ—â–µ–Ω–∫–æ –ï–≤–∞ –ê–Ω–¥—Ä–µ–µ–≤–Ω–∞",
            "–ù—ñ–π –ú–∏–ª–∞–Ω–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞",
            "–û—Å–º–∞–Ω–æ–≤–∞ –≠—Å—Ç—ç–ª—å –≠–º–∏–ª—å–µ–≤–Ω–∞",
            "–ü–æ–Ω–æ–º–∞—Ä–µ–≤–∞ –ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –ú–∞–∫—Å–∏–º–æ–≤–Ω–∞",
            "–ü–æ–ø–æ–≤ –†–æ–º–∞–Ω –í–∏—Ç–∞–ª—å–µ–≤–∏—á",
            "–°–∞–≤—Ä–∞—Å–æ–≤–∞ –í–µ—Ä–æ–Ω–∏–∫–∞ –û–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞",
            "–°–∞—Ä–∏–µ–≤ –ï—Ä–Ω—É—Ä –ï—Ä—Å–∏–Ω–æ–≤–∏—á",
            "–¢–∞—à–∏–º–æ–≤ –°–∞–±—ã—Ä –ù—É—Ä–∂–∞–Ω–æ–≤–∏—á",
            "–¢—É–≥–∞–Ω–±–∞–µ–≤–∞ –ê—Å–µ–ª—å –ê–π–±–µ–∫–æ–≤–Ω–∞"
        ];

        let ratings = [0, 0, 0, 0, 0];
        let allEvaluations = [];
        
        // Google Drive API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ - –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ env-config.js
        const CLIENT_ID = window.env.CLIENT_ID;
        const API_KEY = window.env.API_KEY;
        const SCOPES = window.env.SCOPES;
        const FOLDER_ID = window.env.FOLDER_ID;
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = function() {
            const evaluated = document.getElementById('evaluated');
            const evaluator = document.getElementById('evaluator');
            
            evaluated.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ --</option>';
            evaluator.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–µ –∏–º—è --</option>';
            
            students.forEach(s => {
                evaluated.innerHTML += `<option value="${s}">${s}</option>`;
                evaluator.innerHTML += `<option value="${s}">${s}</option>`;
            });
            
            document.getElementById('date').valueAsDate = new Date();
            
            // Google API –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ onload —Å–æ–±—ã—Ç–∏—è
            
            // Add event listeners for duplicate checking
            document.getElementById('evaluated').addEventListener('change', checkForExistingEvaluation);
            document.getElementById('evaluator').addEventListener('change', checkForExistingEvaluation);
            document.getElementById('date').addEventListener('change', checkForExistingEvaluation);
        };
        

        async function initializeGapiClient() {
            try {
                console.log('Initializing GAPI client...');
                
                // Use a Promise with timeout to handle hanging initialization
                const initPromise = new Promise((resolve, reject) => {
                    gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                    }).then(() => {
                        console.log('GAPI client init completed');
                        resolve();
                    }).catch((err) => {
                        console.error('GAPI init error:', err);
                        reject(err);
                    });
                });
                
                // Add a timeout to prevent hanging
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => {
                        reject(new Error('GAPI initialization timeout after 5 seconds'));
                    }, 5000);
                });
                
                await Promise.race([initPromise, timeoutPromise]);
                
                gapiInited = true;
                console.log('Google API initialized successfully');
                updateAPIStatus();
            } catch(err) {
                console.error('Error initializing GAPI:', err);
                console.error('Error details:', err.message);
                gapiInited = false;
                updateAPIStatus();
            }
        }

        // –û—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ
        function rate(criterion, value) {
            ratings[criterion - 1] = value;
            const buttons = document.querySelectorAll(`#rating${criterion} button`);
            buttons.forEach((btn, i) => {
                btn.classList.toggle('active', i < value);
            });
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏
        async function saveEvaluation() {
            const data = collectEvaluationData();
            if (!data) return;

            // Check for duplicate evaluation on the same day
            const duplicateCheck = await checkForDuplicateEvaluation(data.evaluator, data.evaluated, data.date);
            if (duplicateCheck.isDuplicate) {
                const sourceText = duplicateCheck.source === 'google_drive' ? 
                    '(–Ω–∞–π–¥–µ–Ω–∞ –≤ Google Drive)' : 
                    '(–Ω–∞–π–¥–µ–Ω–∞ –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏)';
                showNotification(`‚ö†Ô∏è –í—ã —É–∂–µ –æ—Ü–µ–Ω–∏–ª–∏ ${data.evaluated} ${duplicateCheck.dateText}! ${sourceText}`, 'error');
                return;
            }

            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = generateEvaluationFileName(data.evaluator, data.evaluated, data.date);
            a.click();

            // Add to local evaluations for duplicate checking
            allEvaluations.push(data);
            
            showNotification('‚úÖ –§–∞–π–ª —Å–∫–∞—á–∞–Ω! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—é –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–∞ Google Drive.', 'success');
        }
        
        // Check for existing evaluation and update form display
        function checkForExistingEvaluation() {
            const evaluator = document.getElementById('evaluator').value;
            const evaluated = document.getElementById('evaluated').value;
            const date = document.getElementById('date').value;
            
            if (!evaluator || !evaluated || !date) {
                clearEvaluationWarning();
                return;
            }
            
            // First check current session (fast)
            const existingEvaluation = allEvaluations.find(ev => 
                ev.evaluator === evaluator && 
                ev.evaluated === evaluated && 
                ev.date === date
            );
            
            if (existingEvaluation) {
                const dateObj = new Date(date);
                const dateText = dateObj.toLocaleDateString('ru-RU', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const duplicateCheck = {
                    isDuplicate: true,
                    dateText: dateText,
                    fileName: generateEvaluationFileName(evaluator, evaluated, date),
                    source: 'current_session'
                };
                
                showEvaluationWarning(duplicateCheck);
                return;
            }
            
            // If not found in current session, check Google Drive asynchronously
            checkGoogleDriveForDuplicate(evaluator, evaluated, date);
        }
        
        // Async Google Drive check (non-blocking)
        async function checkGoogleDriveForDuplicate(evaluator, evaluated, date) {
            try {
                const duplicateCheck = await checkForDuplicateEvaluation(evaluator, evaluated, date);
                
                if (duplicateCheck.isDuplicate) {
                    showEvaluationWarning(duplicateCheck);
                } else {
                    clearEvaluationWarning();
                }
            } catch (error) {
                console.log('Error checking Google Drive for duplicates:', error);
                clearEvaluationWarning();
            }
        }
        
        // Show warning for existing evaluation
        function showEvaluationWarning(duplicateCheck) {
            const warningDiv = document.getElementById('evaluationWarning');
            if (warningDiv) {
                const sourceText = duplicateCheck.source === 'google_drive' ? 
                    '(–Ω–∞–π–¥–µ–Ω–∞ –≤ Google Drive)' : 
                    '(–Ω–∞–π–¥–µ–Ω–∞ –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏)';
                    
                warningDiv.style.display = 'block';
                warningDiv.innerHTML = `
                    <div class="alert" style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404;">
                        <strong>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:</strong> –í—ã —É–∂–µ –æ—Ü–µ–Ω–∏–ª–∏ ${duplicateCheck.evaluated} ${duplicateCheck.dateText}! ${sourceText}<br>
                        <small>–§–∞–π–ª <code>${duplicateCheck.fileName}</code> —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫—É, —Å–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –æ—Ü–µ–Ω–∫—É –∏–∑ —Å–∏—Å—Ç–µ–º—ã –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –¥–∞—Ç—É.</small>
                    </div>
                `;
            }
        }
        
        // Clear evaluation warning
        function clearEvaluationWarning() {
            const warningDiv = document.getElementById('evaluationWarning');
            if (warningDiv) {
                warningDiv.style.display = 'none';
            }
        }
        

        // Check for duplicate evaluation by checking Google Drive
        async function checkForDuplicateEvaluation(evaluator, evaluated, date) {
            // Generate the filename that would be created
            const fileName = generateEvaluationFileName(evaluator, evaluated, date);
            
            // Check if file already exists in allEvaluations (current session)
            const existingEvaluation = allEvaluations.find(ev => 
                ev.evaluator === evaluator && 
                ev.evaluated === evaluated && 
                ev.date === date
            );
            
            if (existingEvaluation) {
                const dateObj = new Date(date);
                const dateText = dateObj.toLocaleDateString('ru-RU', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                return {
                    isDuplicate: true,
                    dateText: dateText,
                    fileName: fileName,
                    existingEvaluation: existingEvaluation,
                    source: 'current_session'
                };
            }
            
            // Check if file exists in Google Drive
            try {
                if (typeof gapiInited !== 'undefined' && typeof gisInited !== 'undefined' && gapiInited && gisInited) {
                    let query = `name='${fileName}'`;
                    
                    // Add folder filter if FOLDER_ID is specified
                    if (typeof FOLDER_ID !== 'undefined' && FOLDER_ID && FOLDER_ID !== 'YOUR_FOLDER_ID') {
                        query += ` and '${FOLDER_ID}' in parents`;
                    }
                    
                    const result = await gapi.client.drive.files.list({
                        q: query,
                        fields: 'files(id,name)'
                    });
                    
                    if (result.result.files && result.result.files.length > 0) {
                        const dateObj = new Date(date);
                        const dateText = dateObj.toLocaleDateString('ru-RU', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        
                        return {
                            isDuplicate: true,
                            dateText: dateText,
                            fileName: fileName,
                            source: 'google_drive'
                        };
                    }
                }
            } catch (error) {
                console.log('Could not check Google Drive for duplicates:', error);
            }
            
            return { isDuplicate: false };
        }
        
        // Generate filename for evaluation
        function generateEvaluationFileName(evaluator, evaluated, date) {
            const evaluatorShort = evaluator.split(' ')[0];
            const evaluatedShort = evaluated.split(' ')[0];
            const dateFormatted = date.replace(/-/g, '_'); // Convert 2025-01-01 to 2025_01_01
            return `evaluation_${evaluatorShort}_${evaluatedShort}_${dateFormatted}.json`;
        }
        
        // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ—Ü–µ–Ω–∫–∏
        function collectEvaluationData() {
            const evaluated = document.getElementById('evaluated').value;
            const evaluator = document.getElementById('evaluator').value;
            const date = document.getElementById('date').value;

            if (!evaluated || !evaluator) {
                alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∏–≤–∞–µ–º–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏ —Å–≤–æ—ë –∏–º—è!');
                return null;
            }

            if (ratings.includes(0)) {
                alert('‚ùå –ü–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫–∏ –ø–æ –≤—Å–µ–º 5 –∫—Ä–∏—Ç–µ—Ä–∏—è–º!');
                return null;
            }

            const total = (ratings[0]/5*30 + ratings[1]/5*25 + ratings[2]/5*20 + ratings[3]/5*15 + ratings[4]/5*10).toFixed(1);

            return {
                evaluated: evaluated,
                evaluator: evaluator,
                date: date,
                ratings: ratings,
                comments: [
                    document.getElementById('comment1').value,
                    document.getElementById('comment2').value,
                    document.getElementById('comment3').value,
                    document.getElementById('comment4').value,
                    document.getElementById('comment5').value
                ],
                total: total
            };
        }
        
        // Show notification function
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;
            
            // Set background color based on type
            if (type === 'success') {
                notification.style.background = '#4CAF50';
            } else if (type === 'error') {
                notification.style.background = '#f44336';
            } else {
                notification.style.background = '#2196F3';
            }
            
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 5000);
        }

        // Add CSS for animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ API
        function updateAPIStatus() {
            const statusText = document.getElementById('apiStatusText');
            const retryButton = document.getElementById('retryAPI');
            
            // Check if elements exist before trying to access them
            if (statusText) {
                if (gapiInited && gisInited) {
                    statusText.innerHTML = '‚úÖ Google Drive API –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é';
                    statusText.style.color = '#4CAF50';
                    if (retryButton) retryButton.style.display = 'none';
                } else {
                    if (!gapiInited && gisInited) {
                        statusText.innerHTML = '‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å Google API. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å"';
                        statusText.style.color = '#f44336';
                    } else {
                        statusText.innerHTML = '‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google API...';
                        statusText.style.color = '#FF9800';
                    }
                    if (retryButton) retryButton.style.display = 'inline-block';
                }
            }
        }

        // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Google API
        function retryGoogleAPI() {
            console.log('Manual retry of Google API initialization...');
            gapiInited = false;
            gisInited = false;
            updateAPIStatus();
            
            // Force reload the scripts
            const script1 = document.createElement('script');
            script1.src = 'https://apis.google.com/js/api.js';
            script1.async = true;
            script1.defer = true;
            script1.onload = gapiLoaded;
            document.head.appendChild(script1);
            
            const script2 = document.createElement('script');
            script2.src = 'https://accounts.google.com/gsi/client';
            script2.async = true;
            script2.defer = true;
            script2.onload = gisLoaded;
            document.head.appendChild(script2);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Google API
        function checkGoogleAPIStatus() {
            updateAPIStatus();
            
            // If GAPI is not working, we can still use GIS for auth and fetch for API calls
            if (!gapiInited && gisInited) {
                console.log('GAPI not available, but GIS is working - using fallback method');
                return true; // Allow operations with fallback
            }
            
            return gapiInited && gisInited;
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ Google Drive
        async function uploadToGoogleDrive() {
            const statusDiv = document.getElementById('driveStatus');
            statusDiv.style.display = 'block';
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ API
            if (!checkGoogleAPIStatus()) {
                statusDiv.innerHTML = `
                    <div class="alert alert-info">
                        <strong>‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google Drive API...</strong><br><br>
                        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ Google API.<br>
                        –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:<br>
                        1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å Client ID –∏ API Key<br>
                        2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É<br>
                        3. –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫<br><br>
                        <button onclick="uploadToGoogleDrive()" class="btn btn-primary" style="margin-top: 10px;">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                    </div>
                `;
                return;
            }
            
            const data = collectEvaluationData();
            if (!data) return;

            statusDiv.innerHTML = '<div class="alert alert-info">‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Drive...</div>';

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    let errorMessage = `‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${resp.error}`;
                    if (resp.error === 'access_denied') {
                        errorMessage += `<br><br><strong>–†–µ—à–µ–Ω–∏–µ –¥–ª—è 403: access_denied:</strong><br>
                        1. <strong>–û—Ç–∑–æ–≤–∏—Ç–µ –¥–æ—Å—Ç—É–ø:</strong> –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="https://myaccount.google.com/security" target="_blank">–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Google</a><br>
                        2. –í —Ä–∞–∑–¥–µ–ª–µ "–°—Ç–æ—Ä–æ–Ω–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –∞–∫–∫–∞—É–Ω—Ç—É" –Ω–∞–π–¥–∏—Ç–µ –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ<br>
                        3. –ù–∞–∂–º–∏—Ç–µ "–£–¥–∞–ª–∏—Ç—å –¥–æ—Å—Ç—É–ø" –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è<br>
                        4. <strong>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ OAuth Consent Screen:</strong><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "APIs & Services" ‚Üí "OAuth consent screen"<br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "Testing", –¥–æ–±–∞–≤—å—Ç–µ artem.sapa@gmail.com –≤ "Test users"<br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ scope "https://www.googleapis.com/auth/drive.file" –¥–æ–±–∞–≤–ª–µ–Ω<br>
                        5. <strong>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Redirect URIs:</strong><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –í "Credentials" ‚Üí –≤–∞—à OAuth 2.0 Client ID<br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ "Authorized JavaScript origins": ${window.location.origin}<br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ "Authorized redirect URIs": ${window.location.origin}<br>
                        6. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ 2-3 –º–∏–Ω—É—Ç—ã<br>
                        7. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞`;
                    } else if (resp.error === 'invalid_request' && resp.error_description && resp.error_description.includes('redirect_uri')) {
                        errorMessage += `<br><br><strong>–†–µ—à–µ–Ω–∏–µ:</strong><br>
                        1. –û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a><br>
                        2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "APIs & Services" ‚Üí "Credentials"<br>
                        3. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à OAuth 2.0 Client ID<br>
                        4. –ù–∞–∂–º–∏—Ç–µ "Edit" (–∫–∞—Ä–∞–Ω–¥–∞—à)<br>
                        5. –í —Ä–∞–∑–¥–µ–ª–µ "Authorized redirect URIs" –¥–æ–±–∞–≤—å—Ç–µ –¢–û–ß–ù–û:<br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ <code>${window.location.origin}</code><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ <code>http://localhost:8000</code><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ <code>http://localhost:3000</code><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ <code>http://localhost:8080</code><br>
                        6. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –∏–ª–∏ —Å–∏–º–≤–æ–ª–æ–≤<br>
                        7. –ù–∞–∂–º–∏—Ç–µ "Save" –∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã<br>
                        8. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞`;
                    }
                    statusDiv.innerHTML = `<div class="alert" style="background: #ffebee;">${errorMessage}</div>`;
                    return;
                }

                try {
                    const fileName = generateEvaluationFileName(data.evaluator, data.evaluated, data.date);
                    const fileContent = JSON.stringify(data, null, 2);
                    
                    // Check if file already exists in Google Drive
                    statusDiv.innerHTML = '<div class="alert alert-info">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤...</div>';
                    
                    let query = `name='${fileName}'`;
                    if (FOLDER_ID && FOLDER_ID !== 'YOUR_FOLDER_ID') {
                        query += ` and '${FOLDER_ID}' in parents`;
                    }
                    
                    const existingFiles = await gapi.client.drive.files.list({
                        q: query,
                        fields: 'files(id,name)'
                    });
                    
                    if (existingFiles.result.files && existingFiles.result.files.length > 0) {
                        statusDiv.innerHTML = `
                            <div class="alert" style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404;">
                                <strong>‚ö†Ô∏è –§–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!</strong><br>
                                –§–∞–π–ª <code>${fileName}</code> —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ Google Drive.<br>
                                <small>–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª, —Å–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª –∏–∑ Google Drive.</small>
                            </div>
                        `;
                        return;
                    }
                    
                    statusDiv.innerHTML = '<div class="alert alert-info">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ Google Drive...</div>';
                    
                    const metadata = {
                        name: fileName,
                        mimeType: 'application/json'
                    };

                    // Add parents array to upload to specific folder
                    if (FOLDER_ID && FOLDER_ID !== 'YOUR_FOLDER_ID') {
                        metadata.parents = [FOLDER_ID];
                    } else {
                        console.log('No folder ID specified, uploading to root directory');
                    }

                    // Use the correct multipart/related format
                    const boundary = 'foo_bar_baz';
                    const delimiter = `\r\n--${boundary}\r\n`;
                    const close_delim = `\r\n--${boundary}--`;
                    
                    const multipartRequestBody = 
                        delimiter +
                        'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                        JSON.stringify(metadata) +
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        fileContent +
                        close_delim;
                    
                    const response = await gapi.client.request({
                        path: 'https://www.googleapis.com/upload/drive/v3/files',
                        method: 'POST',
                        params: {
                            uploadType: 'multipart'
                        },
                        headers: {
                            'Content-Type': 'multipart/related; boundary=' + boundary
                        },
                        body: multipartRequestBody
                    });
                    
                        statusDiv.innerHTML = `
                            <div class="alert alert-success">
                                ‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ Google Drive!<br>
                                <strong>–ò–º—è —Ñ–∞–π–ª–∞:</strong> ${fileName}<br>
                                <a href="https://drive.google.com/file/d/${response.result.id}/view" target="_blank" style="color: #2196F3; font-weight: bold;">–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª –Ω–∞ Google Drive</a>
                            </div>
                        `;
                        
                        // Show success notification
                        showNotification('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ Google Drive!', 'success');
                } catch (err) {
                    statusDiv.innerHTML = `<div class="alert" style="background: #ffebee;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</div>`;
                }
            };

            tokenClient.requestAccessToken();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –æ—Ü–µ–Ω–æ–∫ –Ω–∞ Google Drive
        async function uploadAllToGoogleDrive() {
            const statusDiv = document.getElementById('driveStatus');
            statusDiv.style.display = 'block';
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ API
            if (!checkGoogleAPIStatus()) {
                statusDiv.innerHTML = `
                    <div class="alert alert-info">
                        <strong>‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google Drive API...</strong><br><br>
                        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ Google API.<br>
                        –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:<br>
                        1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å Client ID –∏ API Key<br>
                        2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É<br>
                        3. –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫<br><br>
                        <button onclick="uploadAllToGoogleDrive()" class="btn btn-primary" style="margin-top: 10px;">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                    </div>
                `;
                return;
            }

            if (allEvaluations.length === 0) {
                statusDiv.innerHTML = `
                    <div class="alert alert-info">
                        üìÅ –ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –æ—Ü–µ–Ω–æ–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ Google Drive<br><br>
                        –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –æ—Ü–µ–Ω–æ–∫ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç" –∏–ª–∏ —Å–∫–∞—á–∞–π—Ç–µ –∏—Ö —Å Google Drive –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ü—Ä–æ—Å–º–æ—Ç—Ä".
                    </div>
                `;
                return;
            }

            statusDiv.innerHTML = '<div class="alert alert-info">‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Drive...</div>';

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    let errorMessage = `‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${resp.error}`;
                    if (resp.error === 'access_denied') {
                        errorMessage += `<br><br><strong>–†–µ—à–µ–Ω–∏–µ –¥–ª—è 403: access_denied:</strong><br>
                        1. <strong>–û—Ç–∑–æ–≤–∏—Ç–µ –¥–æ—Å—Ç—É–ø:</strong> –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="https://myaccount.google.com/security" target="_blank">–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Google</a><br>
                        2. –í —Ä–∞–∑–¥–µ–ª–µ "–°—Ç–æ—Ä–æ–Ω–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –∞–∫–∫–∞—É–Ω—Ç—É" –Ω–∞–π–¥–∏—Ç–µ –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ<br>
                        3. –ù–∞–∂–º–∏—Ç–µ "–£–¥–∞–ª–∏—Ç—å –¥–æ—Å—Ç—É–ø" –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è<br>
                        4. <strong>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ OAuth Consent Screen:</strong><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "APIs & Services" ‚Üí "OAuth consent screen"<br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "Testing", –¥–æ–±–∞–≤—å—Ç–µ artem.sapa@gmail.com –≤ "Test users"<br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ scope "https://www.googleapis.com/auth/drive.file" –¥–æ–±–∞–≤–ª–µ–Ω<br>
                        5. <strong>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Redirect URIs:</strong><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –í "Credentials" ‚Üí –≤–∞—à OAuth 2.0 Client ID<br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ "Authorized JavaScript origins": ${window.location.origin}<br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ "Authorized redirect URIs": ${window.location.origin}<br>
                        6. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ 2-3 –º–∏–Ω—É—Ç—ã<br>
                        7. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞`;
                    } else if (resp.error === 'invalid_request' && resp.error_description && resp.error_description.includes('redirect_uri')) {
                        errorMessage += `<br><br><strong>–†–µ—à–µ–Ω–∏–µ:</strong><br>
                        1. –û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a><br>
                        2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "APIs & Services" ‚Üí "Credentials"<br>
                        3. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à OAuth 2.0 Client ID<br>
                        4. –ù–∞–∂–º–∏—Ç–µ "Edit" (–∫–∞—Ä–∞–Ω–¥–∞—à)<br>
                        5. –í —Ä–∞–∑–¥–µ–ª–µ "Authorized redirect URIs" –¥–æ–±–∞–≤—å—Ç–µ –¢–û–ß–ù–û:<br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ <code>${window.location.origin}</code><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ <code>http://localhost:8000</code><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ <code>http://localhost:3000</code><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ <code>http://localhost:8080</code><br>
                        6. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –∏–ª–∏ —Å–∏–º–≤–æ–ª–æ–≤<br>
                        7. –ù–∞–∂–º–∏—Ç–µ "Save" –∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã<br>
                        8. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞`;
                    }
                    statusDiv.innerHTML = `<div class="alert" style="background: #ffebee;">${errorMessage}</div>`;
                    return;
                }

                try {
                    statusDiv.innerHTML = `<div class="alert alert-info">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ ${allEvaluations.length} —Ñ–∞–π–ª–æ–≤ –Ω–∞ Google Drive...</div>`;
                    
                    let successCount = 0;
                    let errorCount = 0;
                    let skippedCount = 0;
                    const results = [];

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –æ—Ü–µ–Ω–∫–∏
                    for (const evaluation of allEvaluations) {
                        try {
                            const fileName = generateEvaluationFileName(evaluation.evaluator, evaluation.evaluated, evaluation.date);
                            const fileContent = JSON.stringify(evaluation, null, 2);
                            
                            // Check if file already exists in Google Drive
                            const bulkCheckToken = gapi.client.getToken();
                            let query = `name='${fileName}'`;
                            
                            // Add folder filter if FOLDER_ID is specified
                            if (FOLDER_ID && FOLDER_ID !== 'YOUR_FOLDER_ID') {
                                query += ` and '${FOLDER_ID}' in parents`;
                            }
                            
                            const existingFiles = await gapi.client.drive.files.list({
                                q: query,
                                fields: 'files(id,name)'
                            });
                            
                            if (existingFiles.result.files && existingFiles.result.files.length > 0) {
                                console.log(`File ${fileName} already exists, skipping...`);
                                skippedCount++;
                                continue; // Skip this file
                            }
                            
                            const metadata = {
                                name: fileName,
                                mimeType: 'application/json'
                            };
                            
                            // Only add parents if FOLDER_ID is valid and accessible
                            if (FOLDER_ID && FOLDER_ID !== 'YOUR_FOLDER_ID') {
                                metadata.parents = [FOLDER_ID];
                    } else {
                                console.log('Bulk upload: No folder ID specified, uploading to root directory');
                            }

                            const boundary = 'foo_bar_baz';
                            const delimiter = `\r\n--${boundary}\r\n`;
                            const close_delim = `\r\n--${boundary}--`;
                            
                            const multipartRequestBody = 
                                delimiter +
                                'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                                JSON.stringify(metadata) +
                                delimiter +
                                'Content-Type: application/json\r\n\r\n' +
                                fileContent +
                                close_delim;
                            
                            const response = await gapi.client.request({
                                path: 'https://www.googleapis.com/upload/drive/v3/files',
                                method: 'POST',
                                params: {
                                    uploadType: 'multipart'
                                },
                                headers: {
                                    'Content-Type': 'multipart/related; boundary=' + boundary
                                },
                                body: multipartRequestBody
                            });
                            
                            const result = response.result;
                            successCount++;
                            results.push({
                                name: fileName,
                                id: result.id,
                                link: `https://drive.google.com/file/d/${result.id}/view`
                            });
                        } catch (err) {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', evaluation.evaluator, '->', evaluation.evaluated, err);
                            errorCount++;
                        }
                    }

                    let resultHtml = `
                        <div class="alert alert-success">
                            ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!<br>
                            <strong>–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:</strong> ${successCount} —Ñ–∞–π–ª–æ–≤<br>
                            ${skippedCount > 0 ? `<strong>–ü—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç):</strong> ${skippedCount} —Ñ–∞–π–ª–æ–≤<br>` : ''}
                            ${errorCount > 0 ? `<strong>–û—à–∏–±–æ–∫:</strong> ${errorCount}<br>` : ''}
                            <br>
                    `;
                    
                    // Show success notification
                    showNotification(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${successCount} —Ñ–∞–π–ª–æ–≤ –Ω–∞ Google Drive!`, 'success');

                    if (results.length > 0) {
                        resultHtml += '<strong>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:</strong><br>';
                        results.forEach(result => {
                            resultHtml += `<a href="${result.link}" target="_blank" style="color: #2196F3; font-weight: bold;">${result.name}</a><br>`;
                        });
                    }

                    resultHtml += '</div>';
                    statusDiv.innerHTML = resultHtml;
                    
                } catch (err) {
                    statusDiv.innerHTML = `<div class="alert" style="background: #ffebee;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</div>`;
                }
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
                    } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —Å Google Drive
        async function downloadFromGoogleDrive() {
            const statusDiv = document.getElementById('driveDownloadStatus');
            statusDiv.style.display = 'block';
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ API
            if (!checkGoogleAPIStatus()) {
                statusDiv.innerHTML = `
                    <div class="alert alert-info">
                        <strong>‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google Drive API...</strong><br><br>
                        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ Google API.<br>
                        –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:<br>
                        1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å Client ID –∏ API Key<br>
                        2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É<br>
                        3. –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫<br><br>
                        <button onclick="downloadFromGoogleDrive()" class="btn btn-primary" style="margin-top: 10px;">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                    </div>
                `;
                return;
            }

            statusDiv.innerHTML = '<div class="alert alert-info">‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Drive...</div>';

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    let errorMessage = `‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${resp.error}`;
                    if (resp.error === 'access_denied') {
                        errorMessage += `<br><br><strong>–†–µ—à–µ–Ω–∏–µ –¥–ª—è 403: access_denied:</strong><br>
                        1. <strong>–û—Ç–∑–æ–≤–∏—Ç–µ –¥–æ—Å—Ç—É–ø:</strong> –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="https://myaccount.google.com/security" target="_blank">–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Google</a><br>
                        2. –í —Ä–∞–∑–¥–µ–ª–µ "–°—Ç–æ—Ä–æ–Ω–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –∞–∫–∫–∞—É–Ω—Ç—É" –Ω–∞–π–¥–∏—Ç–µ –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ<br>
                        3. –ù–∞–∂–º–∏—Ç–µ "–£–¥–∞–ª–∏—Ç—å –¥–æ—Å—Ç—É–ø" –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è<br>
                        4. <strong>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ OAuth Consent Screen:</strong><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "APIs & Services" ‚Üí "OAuth consent screen"<br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "Testing", –¥–æ–±–∞–≤—å—Ç–µ artem.sapa@gmail.com –≤ "Test users"<br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ scope "https://www.googleapis.com/auth/drive.file" –¥–æ–±–∞–≤–ª–µ–Ω<br>
                        5. <strong>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Redirect URIs:</strong><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –í "Credentials" ‚Üí –≤–∞—à OAuth 2.0 Client ID<br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ "Authorized JavaScript origins": ${window.location.origin}<br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ "Authorized redirect URIs": ${window.location.origin}<br>
                        6. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ 2-3 –º–∏–Ω—É—Ç—ã<br>
                        7. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞`;
                    } else if (resp.error === 'invalid_request' && resp.error_description && resp.error_description.includes('redirect_uri')) {
                        errorMessage += `<br><br><strong>–†–µ—à–µ–Ω–∏–µ:</strong><br>
                        1. –û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a><br>
                        2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "APIs & Services" ‚Üí "Credentials"<br>
                        3. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à OAuth 2.0 Client ID<br>
                        4. –ù–∞–∂–º–∏—Ç–µ "Edit" (–∫–∞—Ä–∞–Ω–¥–∞—à)<br>
                        5. –í —Ä–∞–∑–¥–µ–ª–µ "Authorized redirect URIs" –¥–æ–±–∞–≤—å—Ç–µ –¢–û–ß–ù–û:<br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ <code>${window.location.origin}</code><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ <code>http://localhost:8000</code><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ <code>http://localhost:3000</code><br>
                        &nbsp;&nbsp;&nbsp;‚Ä¢ <code>http://localhost:8080</code><br>
                        6. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –∏–ª–∏ —Å–∏–º–≤–æ–ª–æ–≤<br>
                        7. –ù–∞–∂–º–∏—Ç–µ "Save" –∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã<br>
                        8. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞`;
                    }
                    statusDiv.innerHTML = `<div class="alert" style="background: #ffebee;">${errorMessage}</div>`;
                    return;
                }

                try {
                    statusDiv.innerHTML = '<div class="alert alert-info">‚è≥ –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ –æ—Ü–µ–Ω–æ–∫ –Ω–∞ Google Drive...</div>';
                    
                    // –ü–æ–∏—Å–∫ JSON —Ñ–∞–π–ª–æ–≤ –æ—Ü–µ–Ω–æ–∫ –¢–û–õ–¨–ö–û –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ
                    const downloadToken = gapi.client.getToken();
                    
                    // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ FOLDER_ID —É–∫–∞–∑–∞–Ω
                    if (!FOLDER_ID || FOLDER_ID === 'YOUR_FOLDER_ID') {
                        statusDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <strong>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:</strong><br>
                                FOLDER_ID –Ω–µ —É–∫–∞–∑–∞–Ω –≤ config.js<br>
                                –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ ID –ø–∞–ø–∫–∏ Google Drive –≤ config.js
                            </div>
                        `;
                        return;
                    }
                    
                    // –°—Ç—Ä–æ–≥–∏–π –ø–æ–∏—Å–∫ –¢–û–õ–¨–ö–û –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ
                    let query = `'${FOLDER_ID}' in parents and name contains 'evaluation_' and mimeType='application/json' and trashed=false`;
                    
                    console.log('Searching ONLY in folder:', FOLDER_ID);
                    console.log('Query:', query);
                    
                    const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,createdTime)&orderBy=createdTime desc`, {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + downloadToken.access_token
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Failed to list files: ${response.status} ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    const files = result.files;
                    
                    if (files.length === 0) {
                        statusDiv.innerHTML = `
                            <div class="alert alert-info">
                                üìÅ –§–∞–π–ª—ã –æ—Ü–µ–Ω–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ø–∞–ø–∫–µ Google Drive (ID: ${FOLDER_ID})<br><br>
                                –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:<br>
                                1. –§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–∫–∏ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ Google Drive"<br>
                                2. –ò–º—è —Ñ–∞–π–ª–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç "evaluation_"<br>
                                3. –§–∞–π–ª—ã –∏–º–µ—é—Ç —Ñ–æ—Ä–º–∞—Ç JSON<br>
                                4. –§–∞–π–ª—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ (ID: ${FOLDER_ID})<br>
                                5. –§–∞–π–ª—ã –Ω–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∫–æ—Ä–∑–∏–Ω–µ
                            </div>
                        `;
                        return;
                    }

                    statusDiv.innerHTML = `<div class="alert alert-info">‚è≥ –ù–∞–π–¥–µ–Ω–æ ${files.length} —Ñ–∞–π–ª–æ–≤. –ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
                    
                    let loadedCount = 0;
                    let errorCount = 0;
                    allEvaluations = [];

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª
                    for (const file of files) {
                        try {
                            const fileResponse = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, {
                                method: 'GET',
                                headers: {
                                    'Authorization': 'Bearer ' + downloadToken.access_token
                                }
                            });
                            
                            if (!fileResponse.ok) {
                                throw new Error(`Failed to download file: ${fileResponse.status} ${fileResponse.statusText}`);
                            }
                            
                            const fileContent = await fileResponse.text();
                            const data = JSON.parse(fileContent);
                            
                            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
                            const isDuplicate = allEvaluations.some(ev => 
                                ev.evaluated === data.evaluated && ev.evaluator === data.evaluator
                            );
                            
                            if (!isDuplicate) {
                                allEvaluations.push(data);
                                loadedCount++;
                            }
                            
                        } catch (err) {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', file.name, err);
                            errorCount++;
                        }
                    }

                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!<br>
                        </div>
                    `;
                    
                    // Show success notification
                    showNotification(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${loadedCount} –æ—Ü–µ–Ω–æ–∫ —Å Google Drive!`, 'success');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    updateSummary();
                    updateStats();
                    
                } catch (err) {
                    statusDiv.innerHTML = `<div class="alert" style="background: #ffebee;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</div>`;
                }
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        function loadFiles() {
            const files = document.getElementById('fileInput').files;
            if (files.length === 0) {
                alert('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ JSON —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏!\n\n–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª" –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –í–°–ï JSON —Ñ–∞–π–ª—ã –æ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤, —É–¥–µ—Ä–∂–∏–≤–∞—è Ctrl –∏–ª–∏ Cmd)');
                return;
            }

            let loaded = 0;
            let errors = 0;
            let duplicates = 0;
            allEvaluations = [];

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
            const statusDiv = document.getElementById('uploadInfo');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `<strong>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...</strong><br>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è: 0 –∏–∑ ${files.length}`;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
                        const isDuplicate = allEvaluations.some(ev => 
                            ev.evaluated === data.evaluated && ev.evaluator === data.evaluator
                        );
                        
                        if (isDuplicate) {
                            duplicates++;
                        } else {
                            allEvaluations.push(data);
                            loaded++;
                        }
                    } catch (err) {
                        errors++;
                        console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞:', file.name, err);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    statusDiv.innerHTML = `<strong>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...</strong><br>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è: ${loaded + errors + duplicates} –∏–∑ ${files.length}`;
                    
                    // –ö–æ–≥–¥–∞ –≤—Å–µ —Ñ–∞–π–ª—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
                    if (loaded + errors + duplicates === files.length) {
                        let message = `‚úÖ –ó–ê–ì–†–£–ó–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!\n\n`;
                        message += `–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${loaded} –æ—Ü–µ–Ω–æ–∫\n`;
                        if (duplicates > 0) message += `–ü—Ä–æ–ø—É—â–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: ${duplicates}\n`;
                        if (errors > 0) message += `–û—à–∏–±–æ–∫ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏: ${errors}\n`;
                        message += `\n–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ü—Ä–æ—Å–º–æ—Ç—Ä" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã`;
                        
                        alert(message);
                        
                        statusDiv.style.display = 'block';
                        statusDiv.style.background = '#d4edda';
                        statusDiv.innerHTML = `
                            <strong>‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</strong><br>
                            –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: <strong>${loaded}</strong> –æ—Ü–µ–Ω–æ–∫<br>
                            ${duplicates > 0 ? `–ü—Ä–æ–ø—É—â–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: ${duplicates}<br>` : ''}
                            ${errors > 0 ? `–û—à–∏–±–æ–∫: ${errors}<br>` : ''}
                            <br>
                            –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É <strong>"–ü—Ä–æ—Å–º–æ—Ç—Ä"</strong> –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã
                        `;
                        
                        updateSummary();
                        updateStats();
                        
                        // Trigger duplicate check for current form
                        checkForExistingEvaluation();
                    }
                };
                reader.readAsText(file);
            });
        }

        // –†–∞—Å—á–µ—Ç –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ—Ü–µ–Ω–æ–∫ (–Ω–∞—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã –æ—Ü–µ–Ω–∫–∏)
        function calculateRatingObjectivity(evaluatorName) {
            const studentEvaluations = allEvaluations.filter(ev => ev.evaluator === evaluatorName);
            
            if (studentEvaluations.length === 0) return 0;
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –æ—Ü–µ–Ω–∫–∏ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º
            const allRatings = [];
            studentEvaluations.forEach(ev => {
                allRatings.push(...ev.ratings);
            });
            
            if (allRatings.length === 0) return 0;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ (—Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –æ—Ü–µ–Ω–æ–∫)
            const mean = allRatings.reduce((sum, rating) => sum + rating, 0) / allRatings.length;
            const variance = allRatings.reduce((sum, rating) => sum + Math.pow(rating - mean, 2), 0) / allRatings.length;
            const standardDeviation = Math.sqrt(variance);
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–∞—Ä–∏–∞—Ü–∏–∏ (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ)
            const coefficientOfVariation = mean > 0 ? standardDeviation / mean : 0;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (—á–µ–º –±–æ–ª—å—à–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ, —Ç–µ–º –≤—ã—à–µ –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)
            // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–∏ CV = 0.3-0.5 (—Ö–æ—Ä–æ—à–µ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ)
            let objectivityScore = 0;
            if (coefficientOfVariation >= 0.1 && coefficientOfVariation <= 0.8) {
                objectivityScore = Math.min(coefficientOfVariation * 100, 100);
            } else if (coefficientOfVariation < 0.1) {
                // –°–ª–∏—à–∫–æ–º –æ–¥–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ (–≤—Å–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ)
                objectivityScore = coefficientOfVariation * 50; // –®—Ç—Ä–∞—Ñ –∑–∞ –æ–¥–Ω–æ–æ–±—Ä–∞–∑–∏–µ
            } else {
                // –°–ª–∏—à–∫–æ–º —Ö–∞–æ—Ç–∏—á–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏
                objectivityScore = Math.max(100 - (coefficientOfVariation - 0.8) * 200, 0);
            }
            
            return Math.round(objectivityScore * 10) / 10;
        }

        // –†–∞—Å—á–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ—Ü–µ–Ω–∏–≤–∞–Ω–∏—è —Å —É—á–µ—Ç–æ–º –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        function calculateActivityGrades() {
            const activityGrades = {};
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∫–∞–∂–¥—ã–π —Å—Ç—É–¥–µ–Ω—Ç –æ—Ü–µ–Ω–∏–≤–∞–ª –¥—Ä—É–≥–∏—Ö
            const evaluatorCounts = {};
            allEvaluations.forEach(ev => {
                evaluatorCounts[ev.evaluator] = (evaluatorCounts[ev.evaluator] || 0) + 1;
            });
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∫–∞–∂–¥–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ –æ—Ü–µ–Ω–∏–≤–∞–ª–∏
            const evaluatedCounts = {};
            allEvaluations.forEach(ev => {
                evaluatedCounts[ev.evaluated] = (evaluatedCounts[ev.evaluated] || 0) + 1;
            });
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
            students.forEach(student => {
                const timesEvaluated = evaluatorCounts[student] || 0;
                const timesBeingEvaluated = evaluatedCounts[student] || 0;
                
                // –ë–∞–∑–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å = (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ü–µ–Ω–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –¥–∞–ª —Å—Ç—É–¥–µ–Ω—Ç / –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—Ü–µ–Ω–æ–∫) * 100
                const maxPossibleEvaluations = students.length - 1; // –ù–µ –º–æ–∂–µ—Ç –æ—Ü–µ–Ω–∏–≤–∞—Ç—å —Å–µ–±—è
                const participationPercentage = Math.min((timesEvaluated / maxPossibleEvaluations) * 100, 100);
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ü–µ–Ω–æ–∫
                const objectivityScore = calculateRatingObjectivity(student);
                
                // –ò—Ç–æ–≥–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å = –£—á–∞—Å—Ç–∏–µ * –û–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å / 100
                // –ï—Å–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç –æ—Ü–µ–Ω–∏–ª –≤—Å–µ—Ö, –Ω–æ –Ω–µ–æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ - —à—Ç—Ä–∞—Ñ
                // –ï—Å–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç –æ—Ü–µ–Ω–∏–ª –≤—Å–µ—Ö –∏ –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª
                const finalActivityScore = (participationPercentage * objectivityScore) / 100;
                
                activityGrades[student] = {
                    timesEvaluated: timesEvaluated,
                    timesBeingEvaluated: timesBeingEvaluated,
                    participationPercentage: Math.round(participationPercentage * 10) / 10,
                    objectivityScore: objectivityScore,
                    activityPercentage: Math.round(finalActivityScore * 10) / 10
                };
            });
            
            return activityGrades;
        }

        // –†–∞—Å—á–µ—Ç –±–∞–ª–ª–∞ —É—á–∞—Å—Ç–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
        function calculateParticipationScores() {
            const participationScores = {};
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º, –∫–æ–≥–æ –æ—Ü–µ–Ω–∏–≤–∞–ª –∫–∞–∂–¥—ã–π —Å—Ç—É–¥–µ–Ω—Ç
            const studentEvaluations = {};
            students.forEach(student => {
                studentEvaluations[student] = allEvaluations.filter(ev => ev.evaluator === student);
            });
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
            const averageRatings = {};
            students.forEach(student => {
                const evaluations = allEvaluations.filter(ev => ev.evaluated === student);
                if (evaluations.length > 0) {
                    const totalScore = evaluations.reduce((sum, ev) => sum + ev.total, 0);
                    averageRatings[student] = totalScore / evaluations.length;
                } else {
                    averageRatings[student] = 0;
                }
            });
            
            students.forEach(student => {
                const studentEvals = studentEvaluations[student];
                const maxPossibleEvaluations = students.length - 1; // –ù–µ –º–æ–∂–µ—Ç –æ—Ü–µ–Ω–∏–≤–∞—Ç—å —Å–µ–±—è
                
                // 1. –ë–∞–ª–ª –∑–∞ –ø–æ–ª–Ω–æ—Ç—É —É—á–∞—Å—Ç–∏—è (–≤–µ—Å 70%)
                const completenessScore = Math.min((studentEvals.length / maxPossibleEvaluations) * 100, 100);
                
                // 2. –ë–∞–ª–ª –∑–∞ —Ç–æ—á–Ω–æ—Å—Ç—å –æ—Ü–µ–Ω–æ–∫ (–≤–µ—Å 30%)
                let accuracyScore = 0;
                if (studentEvals.length > 0) {
                    let totalAccuracy = 0;
                    let validComparisons = 0;
                    
                    studentEvals.forEach(eval => {
                        const averageRating = averageRatings[eval.evaluated];
                        if (averageRating > 0) {
                            const studentRating = eval.total;
                            const percentageDiff = Math.abs((studentRating - averageRating) / averageRating) * 100;
                            
                            // –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö ¬±20% - –ø–æ–ª–Ω—ã–π –±–∞–ª–ª
                            if (percentageDiff <= 20) {
                                totalAccuracy += 100;
                            } else {
                                // –®—Ç—Ä–∞—Ñ –∑–∞ –±–æ–ª—å—à–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
                                const penalty = Math.min(percentageDiff - 20, 80); // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —à—Ç—Ä–∞—Ñ 80%
                                totalAccuracy += Math.max(100 - penalty, 0);
                            }
                            validComparisons++;
                        }
                    });
                    
                    if (validComparisons > 0) {
                        accuracyScore = totalAccuracy / validComparisons;
                    }
                }
                
                // –ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª: 70% –∑–∞ –ø–æ–ª–Ω–æ—Ç—É + 30% –∑–∞ —Ç–æ—á–Ω–æ—Å—Ç—å
                const finalScore = (completenessScore * 0.7) + (accuracyScore * 0.3);
                
                participationScores[student] = {
                    completenessScore: Math.round(completenessScore * 10) / 10,
                    accuracyScore: Math.round(accuracyScore * 10) / 10,
                    finalScore: Math.round(finalScore * 10) / 10,
                    evaluationsCount: studentEvals.length,
                    maxPossibleEvaluations: maxPossibleEvaluations
                };
            });
            
            return participationScores;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π
        function updateSummary() {
            const div = document.getElementById('summaryTable');
            if (allEvaluations.length === 0) {
                div.innerHTML = '<p>–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –æ—Ü–µ–Ω–æ–∫</p>';
                return;
            }

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –æ—Ü–µ–Ω–∏–≤–∞–µ–º–æ–º—É —Å—Ç—É–¥–µ–Ω—Ç—É
            const grouped = {};
            allEvaluations.forEach(ev => {
                if (!grouped[ev.evaluated]) {
                    grouped[ev.evaluated] = [];
                }
                grouped[ev.evaluated].push(ev);
            });

            let html = '<table><tr><th>–û—Ü–µ–Ω–∏–≤–∞–µ–º—ã–π</th><th>–û—Ü–µ–Ω–∏–≤–∞—é—â–∏–π</th><th>–ö—Ä.1</th><th>–ö—Ä.2</th><th>–ö—Ä.3</th><th>–ö—Ä.4</th><th>–ö—Ä.5</th><th>–ò—Ç–æ–≥–æ %</th></tr>';
            
            // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Ü–µ–Ω–∏–≤–∞–µ–º–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
            Object.keys(grouped).sort().forEach(studentName => {
                const evals = grouped[studentName];
                
                // –í—ã–≤–æ–¥–∏–º –≤—Å–µ –æ—Ü–µ–Ω–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
                evals.forEach((ev, index) => {
                    html += `<tr>`;
                    // –ò–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞ —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ
                    if (index === 0) {
                        html += `<td rowspan="${evals.length + 1}" style="background: #e3f2fd; font-weight: bold; vertical-align: top;">${studentName}</td>`;
                    }
                    html += `
                        <td>${ev.evaluator}</td>
                        <td>${ev.ratings[0]}</td>
                        <td>${ev.ratings[1]}</td>
                        <td>${ev.ratings[2]}</td>
                        <td>${ev.ratings[3]}</td>
                        <td>${ev.ratings[4]}</td>
                        <td><strong>${ev.total}%</strong></td>
                    </tr>`;
                });
                
                // –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞
                const avgTotal = (evals.reduce((sum, e) => sum + parseFloat(e.total), 0) / evals.length).toFixed(1);
                const avgRatings = [0,1,2,3,4].map(i => 
                    (evals.reduce((sum, e) => sum + e.ratings[i], 0) / evals.length).toFixed(1)
                );
                
                html += `<tr style="background: #c8e6c9; font-weight: bold;">
                    <td colspan="1" style="text-align: right;">–°–†–ï–î–ù–ò–ô –ë–ê–õ–õ:</td>
                    <td>${avgRatings[0]}</td>
                    <td>${avgRatings[1]}</td>
                    <td>${avgRatings[2]}</td>
                    <td>${avgRatings[3]}</td>
                    <td>${avgRatings[4]}</td>
                    <td style="font-size: 16px;">${avgTotal}%</td>
                </tr>`;
            });
            
            html += '</table>';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –±–∞–ª–ª–æ–≤ —É—á–∞—Å—Ç–∏—è
            const participationScores = calculateParticipationScores();
            html += '<br><h3>üìä –ë–∞–ª–ª—ã —É—á–∞—Å—Ç–∏—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h3>';
            html += '<table><tr><th>–°—Ç—É–¥–µ–Ω—Ç</th><th>–û—Ü–µ–Ω–æ–∫ –¥–∞–ª</th><th>–ü–æ–ª–Ω–æ—Ç–∞ —É—á–∞—Å—Ç–∏—è</th><th>–¢–æ—á–Ω–æ—Å—Ç—å –æ—Ü–µ–Ω–æ–∫</th><th>–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª</th></tr>';
            
            students.forEach(student => {
                const score = participationScores[student];
                const completenessColor = score.completenessScore >= 100 ? '#4CAF50' : 
                                        score.completenessScore >= 80 ? '#FF9800' : '#f44336';
                const accuracyColor = score.accuracyScore >= 80 ? '#4CAF50' : 
                                     score.accuracyScore >= 60 ? '#FF9800' : '#f44336';
                const finalColor = score.finalScore >= 80 ? '#4CAF50' : 
                                  score.finalScore >= 60 ? '#FF9800' : '#f44336';
                
                html += `
                    <tr>
                        <td><strong>${student}</strong></td>
                        <td>${score.evaluationsCount}/${score.maxPossibleEvaluations}</td>
                        <td style="color: ${completenessColor}; font-weight: bold;">${score.completenessScore}%</td>
                        <td style="color: ${accuracyColor}; font-weight: bold;">${score.accuracyScore}%</td>
                        <td style="color: ${finalColor}; font-weight: bold; font-size: 16px;">${score.finalScore}%</td>
                    </tr>
                `;
            });
            
            html += '</table>';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –±–∞–ª–ª–æ–≤
            html += `
                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>üìã –°–∏—Å—Ç–µ–º–∞ –±–∞–ª–ª–æ–≤ —É—á–∞—Å—Ç–∏—è:</strong><br>
                    ‚Ä¢ <strong>–ü–æ–ª–Ω–æ—Ç–∞ —É—á–∞—Å—Ç–∏—è (70% –≤–µ—Å–∞):</strong> –û—Ü–µ–Ω–∏–ª –ª–∏ —Å—Ç—É–¥–µ–Ω—Ç –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤<br>
                    ‚Ä¢ <strong>–¢–æ—á–Ω–æ—Å—Ç—å –æ—Ü–µ–Ω–æ–∫ (30% –≤–µ—Å–∞):</strong> –ù–∞—Å–∫–æ–ª—å–∫–æ –æ—Ü–µ–Ω–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å—Ä–µ–¥–Ω–∏–º –æ—Ü–µ–Ω–∫–∞–º (¬±20% = –ø–æ–ª–Ω—ã–π –±–∞–ª–ª)<br>
                    ‚Ä¢ <strong>–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª:</strong> 70% √ó –ü–æ–ª–Ω–æ—Ç–∞ + 30% √ó –¢–æ—á–Ω–æ—Å—Ç—å<br>
                    ‚Ä¢ <strong>–¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è:</strong> üü¢ 80%+ (–æ—Ç–ª–∏—á–Ω–æ) | üü† 60-79% (—Ö–æ—Ä–æ—à–æ) | üî¥ <60% (—Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è)
                </div>
            `;
            
            div.innerHTML = html;
        }

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        function updateStats() {
            const div = document.getElementById('stats');
            
            if (allEvaluations.length === 0) {
                div.innerHTML = '<div class="alert alert-info">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –æ—Ü–µ–Ω–æ–∫ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
                return;
            }
            
            const total = allEvaluations.length;
            const avgScore = (allEvaluations.reduce((sum, e) => sum + parseFloat(e.total), 0) / total).toFixed(1);
            
            // –ü–æ–¥—Å—á—ë—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            const uniqueEvaluated = new Set(allEvaluations.map(e => e.evaluated)).size;
            const uniqueEvaluators = new Set(allEvaluations.map(e => e.evaluator)).size;
            
            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            const grouped = {};
            allEvaluations.forEach(ev => {
                if (!grouped[ev.evaluated]) {
                    grouped[ev.evaluated] = [];
                }
                grouped[ev.evaluated].push(parseFloat(ev.total));
            });
            
            // –†–∞—Å—á–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            const activityGrades = calculateActivityGrades();
            
            div.innerHTML = `
                <div class="alert alert-success">
                    <strong>üìä –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:</strong><br><br>
                    <strong>–í—Å–µ–≥–æ –æ—Ü–µ–Ω–æ–∫:</strong> ${total}<br>
                    <strong>–û—Ü–µ–Ω–µ–Ω–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤:</strong> ${uniqueEvaluated} –∏–∑ ${students.length}<br>
                    <strong>–ü—Ä–∏–Ω—è–ª–æ —É—á–∞—Å—Ç–∏–µ –≤ –æ—Ü–µ–Ω–∏–≤–∞–Ω–∏–∏:</strong> ${uniqueEvaluators}<br>
                    <strong>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ –≤—Å–µ–º –æ—Ü–µ–Ω–∫–∞–º:</strong> ${avgScore}%
                </div>
                
                <h3 style="margin-top: 20px;">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –∫–∞–∂–¥–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞:</h3>
                <table>
                    <tr>
                        <th>–°—Ç—É–¥–µ–Ω—Ç</th>
                        <th>–ö–æ–ª-–≤–æ –æ—Ü–µ–Ω–æ–∫</th>
                        <th>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th>
                    </tr>
                    ${Object.keys(grouped).sort().map(name => {
                        const scores = grouped[name];
                        const avg = (scores.reduce((a,b) => a+b, 0) / scores.length).toFixed(1);
                        return `<tr>
                            <td>${name}</td>
                            <td style="text-align: center;">${scores.length}</td>
                            <td style="text-align: center; font-weight: bold;">${avg}%</td>
                        </tr>`;
                    }).join('')}
                </table>
                
                <h3 style="margin-top: 30px;">üìà –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ü–µ–Ω–∏–≤–∞–Ω–∏—è (–∏–∑ 100%):</h3>
                <table>
                    <tr>
                        <th>–°—Ç—É–¥–µ–Ω—Ç</th>
                        <th>–û—Ü–µ–Ω–∏–ª –¥—Ä—É–≥–∏—Ö</th>
                        <th>–ë—ã–ª –æ—Ü–µ–Ω–µ–Ω</th>
                        <th>–£—á–∞—Å—Ç–∏–µ %</th>
                        <th>–û–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å %</th>
                        <th>–ò—Ç–æ–≥–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å %</th>
                    </tr>
                    ${Object.keys(activityGrades).sort().map(name => {
                        const activity = activityGrades[name];
                        const activityColor = activity.activityPercentage >= 80 ? '#4CAF50' : 
                                           activity.activityPercentage >= 60 ? '#FF9800' : '#f44336';
                        const objectivityColor = activity.objectivityScore >= 70 ? '#4CAF50' : 
                                               activity.objectivityScore >= 50 ? '#FF9800' : '#f44336';
                        return `<tr>
                            <td>${name}</td>
                            <td style="text-align: center;">${activity.timesEvaluated}</td>
                            <td style="text-align: center;">${activity.timesBeingEvaluated}</td>
                            <td style="text-align: center;">${activity.participationPercentage}%</td>
                            <td style="text-align: center; color: ${objectivityColor};">${activity.objectivityScore}%</td>
                            <td style="text-align: center; font-weight: bold; color: ${activityColor};">${activity.activityPercentage}%</td>
                        </tr>`;
                    }).join('')}
                </table>
                
                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>üìù –ü–æ—è—Å–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:</strong><br>
                    ‚Ä¢ <strong>–û—Ü–µ–Ω–∏–ª –¥—Ä—É–≥–∏—Ö:</strong> –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å—Ç—É–¥–µ–Ω—Ç –¥–∞–≤–∞–ª –æ—Ü–µ–Ω–∫–∏<br>
                    ‚Ä¢ <strong>–ë—ã–ª –æ—Ü–µ–Ω–µ–Ω:</strong> –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å—Ç—É–¥–µ–Ω—Ç–∞ –æ—Ü–µ–Ω–∏–≤–∞–ª–∏<br>
                    ‚Ä¢ <strong>–£—á–∞—Å—Ç–∏–µ %:</strong> –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ —É—á–∞—Å—Ç–∏—è (–æ—Ü–µ–Ω–∏—Ç—å –≤—Å–µ—Ö)<br>
                    ‚Ä¢ <strong>–û–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å %:</strong> –ù–∞—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã –∏ –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã –æ—Ü–µ–Ω–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞<br>
                    ‚Ä¢ <strong>–ò—Ç–æ–≥–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å %:</strong> –£—á–∞—Å—Ç–∏–µ √ó –û–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–º–∞–∫—Å–∏–º—É–º –ø—Ä–∏ –ø–æ–ª–Ω–æ–º —É—á–∞—Å—Ç–∏–∏ –∏ –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)<br><br>
                    <strong>–¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è:</strong><br>
                    ‚Ä¢ <span style="color: #4CAF50;">üü¢ 80%+</span> - –í—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å<br>
                    ‚Ä¢ <span style="color: #FF9800;">üü° 60-79%</span> - –°—Ä–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å<br>
                    ‚Ä¢ <span style="color: #f44336;">üî¥ <60%</span> - –ù–∏–∑–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å<br><br>
                    <strong>–ü—Ä–∏–º–µ—Ä—ã:</strong><br>
                    ‚Ä¢ –û—Ü–µ–Ω–∏–ª –≤—Å–µ—Ö (100%) + –û–±—ä–µ–∫—Ç–∏–≤–Ω–æ (80%) = 80% –∏—Ç–æ–≥–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏<br>
                    ‚Ä¢ –û—Ü–µ–Ω–∏–ª –≤—Å–µ—Ö (100%) + –ù–µ–æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ (20%) = 20% –∏—Ç–æ–≥–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏<br>
                    ‚Ä¢ –û—Ü–µ–Ω–∏–ª –ø–æ–ª–æ–≤–∏–Ω—É (50%) + –û–±—ä–µ–∫—Ç–∏–≤–Ω–æ (80%) = 40% –∏—Ç–æ–≥–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                </div>
            `;
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV - –¥–µ—Ç–∞–ª—å–Ω—ã–π —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π
        function exportCSV() {
            if (allEvaluations.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –æ—Ü–µ–Ω–∏–≤–∞–µ–º–æ–º—É —Å—Ç—É–¥–µ–Ω—Ç—É
            const grouped = {};
            allEvaluations.forEach(ev => {
                if (!grouped[ev.evaluated]) {
                    grouped[ev.evaluated] = [];
                }
                grouped[ev.evaluated].push(ev);
            });

            let csv = '\uFEFF–û—Ü–µ–Ω–∏–≤–∞–µ–º—ã–π —Å—Ç—É–¥–µ–Ω—Ç,–û—Ü–µ–Ω–∏–≤–∞—é—â–∏–π,–î–∞—Ç–∞,–ö—Ä–∏—Ç–µ—Ä–∏–π 1 (30%),–ö—Ä–∏—Ç–µ—Ä–∏–π 2 (25%),–ö—Ä–∏—Ç–µ—Ä–∏–π 3 (20%),–ö—Ä–∏—Ç–µ—Ä–∏–π 4 (15%),–ö—Ä–∏—Ç–µ—Ä–∏–π 5 (10%),–ò—Ç–æ–≥–æ %\n';
            
            Object.keys(grouped).sort().forEach(studentName => {
                const evals = grouped[studentName];
                
                // –í—Å–µ –æ—Ü–µ–Ω–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
                evals.forEach(ev => {
                    csv += `"${ev.evaluated}","${ev.evaluator}","${ev.date}",${ev.ratings[0]},${ev.ratings[1]},${ev.ratings[2]},${ev.ratings[3]},${ev.ratings[4]},${ev.total}\n`;
                });
                
                // –°—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
                const avgTotal = (evals.reduce((sum, e) => sum + parseFloat(e.total), 0) / evals.length).toFixed(1);
                const avgRatings = [0,1,2,3,4].map(i => 
                    (evals.reduce((sum, e) => sum + e.ratings[i], 0) / evals.length).toFixed(1)
                );
                
                csv += `"${studentName}","–°–†–ï–î–ù–ò–ô –ë–ê–õ–õ","",${avgRatings[0]},${avgRatings[1]},${avgRatings[2]},${avgRatings[3]},${avgRatings[4]},${avgTotal}\n`;
                csv += '\n'; // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–∂–¥—É —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            csv += '\n\n–ê–ö–¢–ò–í–ù–û–°–¢–¨ –û–¶–ï–ù–ò–í–ê–ù–ò–Ø\n';
            csv += '–°—Ç—É–¥–µ–Ω—Ç,–û—Ü–µ–Ω–∏–ª –¥—Ä—É–≥–∏—Ö,–ë—ã–ª –æ—Ü–µ–Ω–µ–Ω,–£—á–∞—Å—Ç–∏–µ %,–û–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å %,–ò—Ç–æ–≥–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å %\n';
            
            const activityGrades = calculateActivityGrades();
            Object.keys(activityGrades).sort().forEach(name => {
                const activity = activityGrades[name];
                csv += `"${name}",${activity.timesEvaluated},${activity.timesBeingEvaluated},${activity.participationPercentage},${activity.objectivityScore},${activity.activityPercentage}\n`;
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–ª–ª—ã —É—á–∞—Å—Ç–∏—è
            csv += '\n\n–ë–ê–õ–õ–´ –£–ß–ê–°–¢–ò–Ø –°–¢–£–î–ï–ù–¢–û–í\n';
            csv += '–°—Ç—É–¥–µ–Ω—Ç,–û—Ü–µ–Ω–æ–∫ –¥–∞–ª,–ú–∞–∫—Å–∏–º—É–º –≤–æ–∑–º–æ–∂–Ω—ã—Ö,–ü–æ–ª–Ω–æ—Ç–∞ —É—á–∞—Å—Ç–∏—è %,–¢–æ—á–Ω–æ—Å—Ç—å –æ—Ü–µ–Ω–æ–∫ %,–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª %\n';
            
            const participationScores = calculateParticipationScores();
            Object.keys(participationScores).sort().forEach(name => {
                const score = participationScores[name];
                csv += `"${name}",${score.evaluationsCount},${score.maxPossibleEvaluations},${score.completenessScore},${score.accuracyScore},${score.finalScore}\n`;
            });

            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'evaluation_360_CONSOLIDATED.csv';
            a.click();

            alert('‚úÖ –°–≤–æ–¥–Ω—ã–π CSV —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω! –û—Ç–∫—Ä–æ–π—Ç–µ –≤ Excel.');
        }

        // –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        function clearData() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?')) {
                allEvaluations = [];
                document.getElementById('summaryTable').innerHTML = '';
                document.getElementById('stats').innerHTML = '';
                
                // Clear any warnings
                clearEvaluationWarning();
                
                alert('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function openTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');

            if (tabId === 'tab2') updateSummary();
            if (tabId === 'tab3') updateStats();
        }
    </script>
</body>
</html>